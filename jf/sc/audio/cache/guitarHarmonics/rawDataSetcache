{|env|varfinalDataSet=FluidDataSet(s);varnumThreads=6;env[\slices].loadToFloatArray(action:{|slices_array|varaverage_sz=floor(slices_array.size/numThreads);varremained=slices_array.size-(average_sz*numThreads);vargroup_sizes=average_sz!(numThreads)+(0!(numThreads-1)++[remained]);varindexes=group_sizes.inject([0],{|o,n|o++(o[o.size-1]+n)});varindex_pairs=[indexes[0..(numThreads-1)],indexes[1..numThreads]].flop;varfuncs=index_pairs.collect{|p,i|{varr=((p[0])..(p[1]));r.doAdjacentPairs{|start,end,index|if(index%128==0,{postf("...slicingfrom%to%onthread%\n",slices_array[start],slices_array[end],i)});if(slices_array[start].isNil.not&&slices_array[end].isNil.not,{varbufs=env[\mkBuffersFunc].();Server.default.sync;finalDataSet.addPoint(start,env[\calcSlice].(bufs,slices_array[start],slices_array[end]));Server.default.sync;bufs.do{|b|b.free}});};postf("thread%finished\n",i);}};funcs.fork();});Server.default.sync;env[\normFunc].(finalDataSet);}